<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Orders - Cost Manager</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <a href="index.html#profit" style="text-decoration: none; color: inherit;">
                <h1 style="cursor: pointer; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-home"></i>
                    Cost Manager
                </h1>
            </a>
            <div class="nav-links">
                <a href="index.html#ingredients" style="text-decoration: none;"><button>Ingredients</button></a>
                <a href="index.html#menu" style="text-decoration: none;"><button>Menu Items</button></a>
                <a href="weekly-orders.html" style="text-decoration: none;"><button class="active">Weekly Orders</button></a>
                <a href="index.html#profit" style="text-decoration: none;"><button>Dashboard</button></a>
            </div>
        </div>

        <!-- Weekly Orders Section -->
        <div style="padding: 25px;">
            <div id="weekly-alert"></div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="margin: 0;">Weekly Ingredient Orders</h2>
                        <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">
                            Update prices for ingredients ordered weekly. Previous prices are shown for comparison.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="invoice-upload" accept=".pdf" style="display: none;" onchange="handleInvoiceUpload(event)">
                        <input type="file" id="weekly-csv-import" accept=".csv" style="display: none;" onchange="handleWeeklyCSVImport(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('invoice-upload').click()">
                            <i class="fas fa-file-invoice"></i> Upload Invoice
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('weekly-csv-import').click()" title="Import from CSV">
                            <i class="fas fa-file-import"></i> Import CSV
                        </button>
                        <button class="btn btn-primary" onclick="exportWeeklyOrdersCSV()" title="Export to CSV">
                           Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="submitWeeklyOrders()" id="submit-weekly-btn">
                            Submit All Orders
                        </button>
                        <button class="btn btn-secondary" onclick="logout()" style="background: #dc2626;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>

                <div id="weekly-orders-container">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Loading weekly orders...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conversion Modal -->
    <div id="conversion-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; margin: 20px;">
            <h3 style="margin-top: 0;">Package to Per-Unit Converter</h3>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                Convert package pricing to per-unit pricing. Example: 1 bag @ $34 containing 20kg → $1.70/kg
            </p>

            <div class="form-group">
                <label>Package Price ($)</label>
                <input type="number" id="conv-package-price" step="0.01" min="0" placeholder="34.00" style="width: 100%;">
            </div>

            <div class="form-group">
                <label>Package Contains (quantity)</label>
                <input type="number" id="conv-package-qty" step="0.01" min="0" placeholder="20" style="width: 100%;">
            </div>

            <div class="form-group">
                <label>Target Quantity (<span id="conv-target-qty"></span> <span id="conv-unit"></span>)</label>
                <input type="number" id="conv-target-amount" step="0.01" min="0" readonly style="width: 100%; background: #f7fafc;">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    This is the quantity already set for this ingredient
                </p>
            </div>

            <div style="padding: 15px; background: #f7fafc; border-radius: 6px; margin: 20px 0;">
                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Calculated Price Per Unit:</div>
                <div id="conv-result" style="font-size: 24px; font-weight: 600; color: #186B28;">-</div>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="closeConversionModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyConversion()">Apply</button>
            </div>
        </div>
    </div>

    <script type="module" src="./script-supabase.js"></script>
    <script type="module">
        import { supabase } from './script-supabase.js';

        const $ = (sel) => document.querySelector(sel);
        const fmtMoney = (n) => (isNaN(n) ? "$0.00" : `$${Number(n).toFixed(2)}`);

        // Check authentication
        console.log('Checking authentication...');
        const { data: { session } } = await supabase.auth.getSession();
        console.log('Session:', session);

        if (!session) {
            console.log('No session, redirecting to login...');
            window.location.href = 'login.html';
        } else {
            console.log('Authenticated user:', session.user.email);
        }

        function showNotification(message, type = 'success') {
            const alert = $('#weekly-alert');
            alert.className = type === 'error' ? 'alert alert-error' : 'alert alert-success';
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        async function loadWeeklyOrders() {
            try {
                console.log('Loading weekly orders...');
                // Try to get all ingredients first to test
                const { data: allIngredients, error: testError } = await supabase
                    .from('ingredients')
                    .select('*')
                    .limit(1);

                console.log('Test query:', { allIngredients, testError });

                const { data: ingredients, error } = await supabase
                    .from('ingredients')
                    .select('*')
                    .eq('is_weekly_order', true)
                    .eq('is_deleted', false)
                    .order('name');

                console.log('Query result:', { ingredients, error });

                if (error) throw error;

                const container = $('#weekly-orders-container');

                if (!ingredients || ingredients.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 16px; margin-bottom: 10px;">No weekly order ingredients found</p>
                            <p style="font-size: 14px;">Mark ingredients as "Weekly Order" in the Ingredients page to see them here.</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Ingredient</th>
                                <th style="text-align: center; width: 100px;">Qty</th>
                                <th style="text-align: center; width: 80px;">Unit</th>
                                <th style="text-align: right; width: 130px;">Last Price/Unit</th>
                                <th style="text-align: right; width: 130px;">New Price/Unit ($)</th>
                                <th style="text-align: right; width: 130px;">Total Price</th>
                                <th style="text-align: center; width: 100px;">Change</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const ing of ingredients) {
                    const lastTotalPrice = ing.last_weekly_price || ing.total_price;
                    const lastPricePerUnit = lastTotalPrice / ing.quantity;
                    const currentPricePerUnit = ing.price_per_unit || (ing.total_price / ing.quantity);
                    const lastDate = ing.last_weekly_date
                        ? new Date(ing.last_weekly_date).toLocaleDateString()
                        : 'N/A';

                    html += `
                        <tr data-ingredient-id="${ing.id}">
                            <td>
                                <strong>${ing.name}</strong>
                                ${ing.semantic_id ? `<br><span style="color: #186B28; font-size: 12px; font-family: monospace;">${ing.semantic_id}</span>` : ''}
                            </td>
                            <td style="text-align: center;">${ing.quantity}</td>
                            <td style="text-align: center;">${ing.unit}</td>
                            <td style="text-align: right;">
                                <div style="font-size: 14px;">${fmtMoney(lastPricePerUnit)}</div>
                                <div style="font-size: 11px; color: #666;">${lastDate}</div>
                            </td>
                            <td style="text-align: right; position: relative;">
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        class="weekly-price-input"
                                        data-id="${ing.id}"
                                        data-last-price-per-unit="${lastPricePerUnit}"
                                        data-quantity="${ing.quantity}"
                                        value="${currentPricePerUnit.toFixed(2)}"
                                        style="flex: 1; text-align: right; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;"
                                        oninput="updateFromPricePerUnit(this)"
                                    >
                                    <button
                                        onclick="showConversionModal(${ing.id}, ${ing.quantity}, '${ing.unit}')"
                                        class="btn btn-secondary"
                                        style="padding: 8px 10px; font-size: 12px; min-width: auto;"
                                        title="Convert package price to per-unit price"
                                    >
                                        <i class="fas fa-calculator"></i>
                                    </button>
                                </div>
                            </td>
                            <td style="text-align: right;">
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    class="weekly-total-input"
                                    data-id="${ing.id}"
                                    data-quantity="${ing.quantity}"
                                    value="${(ing.quantity * currentPricePerUnit).toFixed(2)}"
                                    style="width: 100%; text-align: right; padding: 8px; border: 2px solid #e2e8f0; border-radius: 4px;"
                                    oninput="updateFromTotalPrice(this)"
                                >
                            </td>
                            <td style="text-align: center;">
                                <div id="change-${ing.id}" style="font-weight: 600; font-size: 14px;">-</div>
                            </td>
                        </tr>
                    `;
                }

                html += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = html;

                // Calculate initial changes
                document.querySelectorAll('.weekly-price-input').forEach(input => {
                    updateFromPricePerUnit(input);
                });

            } catch (err) {
                console.error('Error loading weekly orders:', err);
                const container = $('#weekly-orders-container');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #c00;">
                        <p style="font-size: 16px; margin-bottom: 10px;">Error loading weekly orders</p>
                        <p style="font-size: 14px;">${err.message}</p>
                        <button class="btn btn-primary" onclick="loadWeeklyOrders()" style="margin-top: 20px;">
                            Retry
                        </button>
                    </div>
                `;
                showNotification('Error loading weekly orders: ' + err.message, 'error');
            }
        }

        // Update when user changes price per unit
        window.updateFromPricePerUnit = function(pricePerUnitInput) {
            const id = pricePerUnitInput.dataset.id;
            const lastPricePerUnit = parseFloat(pricePerUnitInput.dataset.lastPricePerUnit);
            const newPricePerUnit = parseFloat(pricePerUnitInput.value);
            const quantity = parseFloat(pricePerUnitInput.dataset.quantity);

            const changeDiv = document.getElementById(`change-${id}`);
            const totalInput = document.querySelector(`.weekly-total-input[data-id="${id}"]`);

            if (isNaN(newPricePerUnit) || newPricePerUnit < 0) {
                changeDiv.textContent = '-';
                changeDiv.style.color = '#666';
                if (totalInput) totalInput.value = '';
                return;
            }

            // Update total price input
            const totalPrice = quantity * newPricePerUnit;
            if (totalInput) {
                totalInput.value = totalPrice.toFixed(2);
            }

            // Update change indicator
            updateChangeIndicator(pricePerUnitInput, changeDiv, newPricePerUnit, lastPricePerUnit);
        };

        // Update when user changes total price
        window.updateFromTotalPrice = function(totalInput) {
            const id = totalInput.dataset.id;
            const quantity = parseFloat(totalInput.dataset.quantity);
            const newTotalPrice = parseFloat(totalInput.value);

            const pricePerUnitInput = document.querySelector(`.weekly-price-input[data-id="${id}"]`);
            const lastPricePerUnit = parseFloat(pricePerUnitInput.dataset.lastPricePerUnit);
            const changeDiv = document.getElementById(`change-${id}`);

            if (isNaN(newTotalPrice) || newTotalPrice < 0) {
                changeDiv.textContent = '-';
                changeDiv.style.color = '#666';
                if (pricePerUnitInput) pricePerUnitInput.value = '';
                return;
            }

            // Calculate and update price per unit
            const newPricePerUnit = newTotalPrice / quantity;
            if (pricePerUnitInput) {
                pricePerUnitInput.value = newPricePerUnit.toFixed(2);
            }

            // Update change indicator
            updateChangeIndicator(totalInput, changeDiv, newPricePerUnit, lastPricePerUnit);
        };

        // Helper to update change indicator styling
        function updateChangeIndicator(input, changeDiv, newPricePerUnit, lastPricePerUnit) {
            const change = newPricePerUnit - lastPricePerUnit;
            const changePercent = lastPricePerUnit > 0 ? (change / lastPricePerUnit * 100).toFixed(1) : 0;

            // Find both inputs to style them the same
            const id = input.dataset.id;
            const priceInput = document.querySelector(`.weekly-price-input[data-id="${id}"]`);
            const totalInput = document.querySelector(`.weekly-total-input[data-id="${id}"]`);

            if (Math.abs(change) < 0.01) {
                changeDiv.innerHTML = '—';
                changeDiv.style.color = '#666';
                if (priceInput) {
                    priceInput.style.borderColor = '#e2e8f0';
                    priceInput.style.background = '#fff';
                }
                if (totalInput) {
                    totalInput.style.borderColor = '#e2e8f0';
                    totalInput.style.background = '#fff';
                }
            } else if (change > 0) {
                changeDiv.innerHTML = `↑ ${fmtMoney(change)}<br><span style="font-size: 12px;">(+${changePercent}%)</span>`;
                changeDiv.style.color = '#c00';
                if (priceInput) {
                    priceInput.style.borderColor = '#fbb';
                    priceInput.style.background = '#fff5f5';
                }
                if (totalInput) {
                    totalInput.style.borderColor = '#fbb';
                    totalInput.style.background = '#fff5f5';
                }
            } else {
                changeDiv.innerHTML = `↓ ${fmtMoney(Math.abs(change))}<br><span style="font-size: 12px;">(${changePercent}%)</span>`;
                changeDiv.style.color = '#0a0';
                if (priceInput) {
                    priceInput.style.borderColor = '#bfb';
                    priceInput.style.background = '#f5fff5';
                }
                if (totalInput) {
                    totalInput.style.borderColor = '#bfb';
                    totalInput.style.background = '#f5fff5';
                }
            }
        }

        window.submitWeeklyOrders = async function() {
            const inputs = document.querySelectorAll('.weekly-price-input');
            const updates = [];
            let hasChanges = false;

            for (const input of inputs) {
                const id = parseInt(input.dataset.id);
                const pricePerUnit = parseFloat(input.value);
                const lastPricePerUnit = parseFloat(input.dataset.lastPricePerUnit);
                const quantity = parseFloat(input.dataset.quantity);

                if (isNaN(pricePerUnit) || pricePerUnit < 0) {
                    showNotification('Please enter valid prices for all ingredients', 'error');
                    return;
                }

                if (pricePerUnit !== lastPricePerUnit) {
                    hasChanges = true;
                }

                const totalPrice = quantity * pricePerUnit;

                updates.push({
                    id,
                    pricePerUnit,
                    totalPrice,
                    quantity
                });
            }

            if (!hasChanges) {
                showNotification('No price changes detected', 'error');
                return;
            }

            if (!confirm(`Submit weekly orders for ${updates.length} ingredient(s)?`)) {
                return;
            }

            const submitBtn = $('#submit-weekly-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                for (const update of updates) {
                    // Update ingredient with new price and track last weekly price
                    const { error: updateError } = await supabase
                        .from('ingredients')
                        .update({
                            total_price: update.totalPrice,
                            price_per_unit: update.pricePerUnit,
                            last_weekly_price: update.totalPrice,
                            last_weekly_date: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', update.id);

                    if (updateError) throw updateError;

                    // Get ingredient name for history
                    const { data: ing } = await supabase
                        .from('ingredients')
                        .select('name, unit, is_informational')
                        .eq('id', update.id)
                        .single();

                    // Log to price history
                    await supabase
                        .from('ingredient_price_history')
                        .insert([{
                            ingredient_id: update.id,
                            ingredient_name: ing.name,
                            quantity: update.quantity,
                            unit: ing.unit,
                            total_price: update.totalPrice,
                            price_per_unit: update.pricePerUnit,
                            is_informational: ing.is_informational
                        }]);
                }

                showNotification('Weekly orders submitted successfully!', 'success');
                await loadWeeklyOrders();

            } catch (err) {
                console.error('Error submitting weekly orders:', err);
                showNotification('Error: ' + err.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit All Orders';
            }
        };

        // Logout function
        window.logout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            }
        };

        // Load orders when page loads
        console.log('Setting up DOMContentLoaded listener...');
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded fired!');
            loadWeeklyOrders();
        });

        // Also try loading immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            console.log('DOM still loading, waiting for DOMContentLoaded...');
        } else {
            console.log('DOM already loaded, calling loadWeeklyOrders immediately...');
            loadWeeklyOrders();
        }

        // ===== INVOICE UPLOAD & PROCESSING =====

        window.handleInvoiceUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            showNotification('Processing invoice... This may take a moment.', 'success');

            try {
                // Upload PDF to Supabase Storage
                const fileName = `invoice_${Date.now()}_${file.name}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('invoices')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                // Convert PDF to images
                const images = await convertPdfToImages(file);

                // Extract data using Claude API
                const extractedData = await extractInvoiceData(images);
                console.log('Extracted data from AI:', extractedData);

                // Auto-fill the prices
                const matchCount = await autoFillPrices(extractedData);

                showNotification(`Invoice processed! Matched ${matchCount} of ${extractedData.length} items.`, 'success');

            } catch (err) {
                console.error('Error processing invoice:', err);
                showNotification('Error processing invoice: ' + err.message, 'error');
            } finally {
                // Reset file input
                event.target.value = '';
            }
        };

        async function convertPdfToImages(file) {
            // Load PDF.js dynamically
            if (!window.pdfjsLib) {
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const images = [];

            // Convert each page to image
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 2.0 });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                // Convert canvas to base64
                const base64 = canvas.toDataURL('image/png').split(',')[1];
                images.push(base64);
            }

            return images;
        }

        async function extractInvoiceData(images) {
            // Call Supabase Edge Function instead of Claude API directly
            const { data: { user } } = await supabase.auth.getUser();

            const response = await supabase.functions.invoke('storage-upload', {
                body: { image: images[0] }
            });

            if (response.error) {
                throw new Error(response.error.message || 'Failed to process invoice');
            }

            return response.data.data;
        }

        async function autoFillPrices(extractedData) {
            const inputs = document.querySelectorAll('.weekly-price-input');
            let matchCount = 0;

            for (const input of inputs) {
                const ingredientRow = input.closest('tr');
                const ingredientNameEl = ingredientRow.querySelector('strong');
                if (!ingredientNameEl) continue;

                const ingredientName = ingredientNameEl.textContent.toLowerCase().trim();
                const quantity = parseFloat(input.dataset.quantity);

                // Try to find a match in extracted data
                const match = extractedData.find(item => {
                    const extractedName = item.ingredient.toLowerCase().trim();

                    // Remove ALL special characters and spaces for basic comparison
                    const normalizedIngredient = ingredientName.replace(/[^a-z0-9]/g, '');
                    const normalizedExtracted = extractedName.replace(/[^a-z0-9]/g, '');

                    // Extract key words (longer than 3 chars) from both names
                    const getKeyWords = (str) => {
                        // Split by non-alphanumeric, filter short words
                        return str.toLowerCase()
                            .split(/[^a-z0-9]+/)
                            .filter(w => w.length > 3);
                    };

                    const ingredientKeyWords = getKeyWords(ingredientName);
                    const extractedKeyWords = getKeyWords(extractedName);

                    // Count how many key words match
                    const matchingWords = ingredientKeyWords.filter(word =>
                        extractedKeyWords.some(ew =>
                            word.includes(ew) ||
                            ew.includes(word) ||
                            normalizedExtracted.includes(word)
                        )
                    );

                    console.log(`Comparing "${ingredientName}" with "${extractedName}"`, {
                        ingredientKeyWords,
                        extractedKeyWords,
                        matchingWords,
                        normalizedMatch: normalizedExtracted.includes(normalizedIngredient) || normalizedIngredient.includes(normalizedExtracted)
                    });

                    // Match if:
                    // 1. Normalized strings contain each other
                    // 2. At least 2 key words match
                    // 3. High similarity score
                    return normalizedExtracted.includes(normalizedIngredient) ||
                           normalizedIngredient.includes(normalizedExtracted) ||
                           matchingWords.length >= 2 ||
                           ingredientName.includes(extractedName) ||
                           extractedName.includes(ingredientName) ||
                           similarText(normalizedIngredient, normalizedExtracted) > 0.65;
                });

                if (match) {
                    console.log('Matched:', ingredientName, 'with', match);

                    // Calculate price per unit
                    let pricePerUnit;

                    if (match.pricePerUnit !== undefined && !isNaN(match.pricePerUnit)) {
                        // Explicit pricePerUnit field
                        pricePerUnit = match.pricePerUnit;
                    } else if (match.price !== undefined && !isNaN(match.price)) {
                        // Generic "price" field - assume it's already per unit from AI
                        // (AI extracts unit prices from invoices like "$9.00 per kg")
                        pricePerUnit = match.price;
                    } else if (match.totalPrice !== undefined && !isNaN(match.totalPrice)) {
                        // Has totalPrice, calculate pricePerUnit
                        const extractedQty = match.quantity || quantity;
                        pricePerUnit = match.totalPrice / extractedQty;
                    } else {
                        console.warn('No valid price found in match:', match);
                        continue;
                    }

                    console.log('Using pricePerUnit:', pricePerUnit);

                    if (!isNaN(pricePerUnit) && pricePerUnit > 0) {
                        input.value = pricePerUnit.toFixed(2);
                        updateFromPricePerUnit(input);
                        matchCount++;

                        // Highlight matched row
                        ingredientRow.style.background = '#f0f9ff';
                        setTimeout(() => {
                            ingredientRow.style.background = '';
                        }, 3000);
                    }
                }
            }

            console.log(`Matched ${matchCount} ingredients`);
            return matchCount;
        }

        // Helper function for fuzzy string matching
        function similarText(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;

            if (longer.length === 0) return 1.0;

            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ===== CONVERSION CALCULATOR =====

        let currentConversionId = null;

        window.showConversionModal = function(id, targetQty, unit) {
            currentConversionId = id;

            // Populate modal with ingredient info
            $('#conv-target-qty').textContent = targetQty;
            $('#conv-unit').textContent = unit;
            $('#conv-target-amount').value = targetQty;

            // Clear previous inputs
            $('#conv-package-price').value = '';
            $('#conv-package-qty').value = '';
            $('#conv-result').textContent = '-';

            // Show modal
            $('#conversion-modal').style.display = 'flex';

            // Focus on first input
            setTimeout(() => $('#conv-package-price').focus(), 100);

            // Set up real-time calculation
            const calculate = () => {
                const packagePrice = parseFloat($('#conv-package-price').value);
                const packageQty = parseFloat($('#conv-package-qty').value);

                if (!isNaN(packagePrice) && !isNaN(packageQty) && packageQty > 0) {
                    const pricePerUnit = packagePrice / packageQty;
                    $('#conv-result').textContent = fmtMoney(pricePerUnit);
                } else {
                    $('#conv-result').textContent = '-';
                }
            };

            // Attach listeners
            $('#conv-package-price').oninput = calculate;
            $('#conv-package-qty').oninput = calculate;
        };

        window.closeConversionModal = function() {
            $('#conversion-modal').style.display = 'none';
            $('#conv-package-price').value = '';
            $('#conv-package-qty').value = '';
            $('#conv-result').textContent = '-';
            currentConversionId = null;
        };

        window.applyConversion = function() {
            // Get the calculated result
            const resultText = $('#conv-result').textContent;

            if (resultText === '-') {
                showNotification('Please enter valid package price and quantity', 'error');
                return;
            }

            // Parse the price (remove $ and commas)
            const pricePerUnit = parseFloat(resultText.replace(/[$,]/g, ''));

            if (isNaN(pricePerUnit) || pricePerUnit <= 0) {
                showNotification('Invalid calculated price', 'error');
                return;
            }

            // Find the input and update it
            const input = document.querySelector(`.weekly-price-input[data-id="${currentConversionId}"]`);

            if (input) {
                input.value = pricePerUnit.toFixed(2);
                updateFromPricePerUnit(input);
                showNotification('Price updated from conversion!', 'success');
            }

            closeConversionModal();
        };

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = $('#conversion-modal');
            if (event.target === modal) {
                closeConversionModal();
            }
        });

        // Close modal on Escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = $('#conversion-modal');
                if (modal.style.display === 'flex') {
                    closeConversionModal();
                }
            }
        });

        // ===== CSV IMPORT/EXPORT FOR WEEKLY ORDERS =====

        window.exportWeeklyOrdersCSV = async function() {
            try {
                const { data: ingredients, error } = await supabase
                    .from('ingredients')
                    .select('*')
                    .eq('is_weekly_order', true)
                    .eq('is_deleted', false)
                    .order('name');

                if (error) throw error;

                if (!ingredients || ingredients.length === 0) {
                    showNotification('No weekly order ingredients to export', 'error');
                    return;
                }

                const rows = [
                    ['Ingredient Name', 'Quantity', 'Unit', 'Price Per Unit', 'Total Price', 'Supplier', 'Semantic ID'],
                    ...(ingredients || []).map(ing => [
                        ing.name,
                        ing.quantity,
                        ing.unit,
                        ing.price_per_unit || (ing.total_price / ing.quantity),
                        ing.total_price,
                        ing.supplier || '',
                        ing.semantic_id || ''
                    ])
                ];

                const csvContent = rows.map(row =>
                    row.map(cell => {
                        const str = String(cell);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return '"' + str.replace(/"/g, '""') + '"';
                        }
                        return str;
                    }).join(',')
                ).join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `weekly-orders-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('Weekly orders exported successfully!', 'success');
            } catch (err) {
                console.error('Export error:', err);
                showNotification(`Export failed: ${err.message}`, 'error');
            }
        };

        window.handleWeeklyCSVImport = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const rows = parseCSVText(text);

                if (rows.length < 2) {
                    showNotification('CSV file is empty or invalid', 'error');
                    return;
                }

                const headers = rows[0].map(h => h.trim().toLowerCase());
                const dataRows = rows.slice(1);

                const requiredHeaders = ['ingredient name', 'price per unit'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));

                if (missingHeaders.length > 0) {
                    showNotification(`Missing required columns: ${missingHeaders.join(', ')}`, 'error');
                    return;
                }

                const getIndex = (name) => headers.indexOf(name);
                const nameIdx = getIndex('ingredient name');
                const pricePerUnitIdx = getIndex('price per unit');
                const totalPriceIdx = getIndex('total price');
                const supplierIdx = getIndex('supplier');
                const qtyIdx = getIndex('quantity');
                const unitIdx = getIndex('unit');
                const semanticIdx = getIndex('semantic id');

                const updates = [];
                const errors = [];

                for (let i = 0; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    const rowNum = i + 2;

                    if (row.every(cell => !cell || cell.trim() === '')) continue;

                    const name = row[nameIdx]?.trim();
                    const pricePerUnit = parseFloat(row[pricePerUnitIdx]);

                    if (!name) {
                        errors.push(`Row ${rowNum}: Missing ingredient name`);
                        continue;
                    }
                    if (isNaN(pricePerUnit) || pricePerUnit < 0) {
                        errors.push(`Row ${rowNum}: Invalid price for "${name}"`);
                        continue;
                    }

                    const supplier = supplierIdx >= 0 ? row[supplierIdx]?.trim() : null;
                    const quantity = qtyIdx >= 0 ? parseFloat(row[qtyIdx]) : null;
                    const unit = unitIdx >= 0 ? row[unitIdx]?.trim() : null;
                    const totalPrice = totalPriceIdx >= 0 ? parseFloat(row[totalPriceIdx]) : null;
                    const semanticId = semanticIdx >= 0 ? row[semanticIdx]?.trim() : null;

                    updates.push({ name, pricePerUnit, totalPrice, supplier, quantity, unit, semanticId });
                }

                if (updates.length === 0) {
                    showNotification('No valid data found in CSV', 'error');
                    return;
                }

                const confirmMsg = `Import ${updates.length} ingredient(s)?\n\nThis will update existing ingredients and add new ones.${errors.length > 0 ? `\n\n${errors.length} row(s) had errors and will be skipped.` : ''}`;
                if (!confirm(confirmMsg)) {
                    event.target.value = '';
                    return;
                }

                let updatedCount = 0;
                let insertedCount = 0;

                for (const update of updates) {
                    try {
                        let query = supabase
                            .from('ingredients')
                            .select('id, quantity, unit')
                            .eq('is_weekly_order', true)
                            .eq('is_deleted', false);

                        if (update.semanticId) {
                            query = query.eq('semantic_id', update.semanticId);
                        } else {
                            query = query.ilike('name', update.name);
                        }

                        const { data: existing } = await query.single();

                        if (existing) {
                            // Update existing ingredient
                            const finalQuantity = update.quantity || existing.quantity;
                            const finalUnit = update.unit || existing.unit;
                            const finalTotalPrice = update.totalPrice || (update.pricePerUnit * finalQuantity);

                            const updateData = {
                                price_per_unit: update.pricePerUnit,
                                total_price: finalTotalPrice,
                                updated_at: new Date().toISOString()
                            };

                            // Only add supplier if column exists (comment out for now)
                            if (update.supplier) updateData.supplier = update.supplier;
                            if (update.quantity) updateData.quantity = update.quantity;
                            if (update.unit) updateData.unit = update.unit;

                            const { error: updateError } = await supabase
                                .from('ingredients')
                                .update(updateData)
                                .eq('id', existing.id);

                            if (updateError) throw updateError;
                            updatedCount++;
                        } else {
                            // Insert new ingredient
                            // Require quantity and unit for new ingredients
                            if (!update.quantity || !update.unit) {
                                errors.push(`Cannot insert "${update.name}": Missing quantity or unit`);
                                continue;
                            }

                            const finalTotalPrice = update.totalPrice || (update.pricePerUnit * update.quantity);

                            const newIngredient = {
                                name: update.name,
                                quantity: update.quantity,
                                unit: update.unit,
                                price_per_unit: update.pricePerUnit,
                                total_price: finalTotalPrice,
                                is_weekly_order: true,
                                is_informational: false,
                                is_deleted: false,
                                semantic_id: update.semanticId || null,
                                supplier: update.supplier || null,  // Column doesn't exist yet
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            };

                            const { error: insertError } = await supabase
                                .from('ingredients')
                                .insert([newIngredient]);

                            if (insertError) throw insertError;
                            insertedCount++;
                        }
                    } catch (err) {
                        console.error(`Error processing "${update.name}":`, err);
                        errors.push(`Failed to process "${update.name}": ${err.message}`);
                    }
                }

                const totalProcessed = updatedCount + insertedCount;
                showNotification(`Successfully imported ${totalProcessed} ingredient(s)! (${insertedCount} new, ${updatedCount} updated)`, 'success');

                if (errors.length > 0) {
                    console.warn('CSV Import Warnings:', errors);
                    alert(`Imported ${totalProcessed} ingredients (${insertedCount} new, ${updatedCount} updated).\n\n${errors.length} error(s):\n` +
                        errors.slice(0, 5).join('\n') +
                        (errors.length > 5 ? `\n...and ${errors.length - 5} more (check console)` : ''));
                }

                await loadWeeklyOrders();

            } catch (err) {
                console.error('CSV Import Error:', err);
                showNotification(`Import failed: ${err.message}`, 'error');
            } finally {
                event.target.value = '';
            }
        };

        function parseCSVText(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentCell);
                    currentCell = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    currentRow.push(currentCell);
                    if (currentRow.some(cell => cell.trim() !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }

            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell);
                if (currentRow.some(cell => cell.trim() !== '')) {
                    rows.push(currentRow);
                }
            }

            return rows;
        }
    </script>
</body>
</html>
